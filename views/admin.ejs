<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>
  <meta name="viewport" content="width=1200">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/admin.css" rel="stylesheet">
</head>
<body>
  <div class="admin-nav">
    <div class="admin-container d-flex justify-content-between align-items-center">
      <h2>Admin Panel</h2>
      <form action="/logout" method="POST" style="margin: 0">
        <button type="submit" class="btn">Logout</button>
      </form>
    </div>
  </div>

  <div class="admin-container">
    <ul class="nav nav-tabs" id="adminTabs">
      <li class="nav-item">
        <a class="nav-link active" href="#userSection" data-bs-toggle="tab">Users</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#withdrawalSection" data-bs-toggle="tab">Withdrawals</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#depositSection" data-bs-toggle="tab">Deposits</a>
      </li>
    </ul>

    <div class="tab-content">
      <!-- Users Section -->
      <div id="userSection" class="tab-pane fade show active">
        <div class="card">
          <div class="card-header">
            <h4>User Management</h4>
            <div class="search-filters">
  <input type="text" id="userSearch" class="form-control" placeholder="Search by UID or Username" onkeyup="searchUsers()">
  <select class="form-control" id="userStatusFilter" onchange="searchUsers()">
    <option value="all">All Status</option>
    <option value="active">Active</option>
    <option value="banned">Banned</option>
  </select>
</div>
          </div>
          <div class="table-responsive">
            <table class="table" id="userTable">
              <thead>
                <tr>
                  <th>UID</th>
                  <th>Username</th>
                  <th>Balance</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% users.forEach(user => { %>
                <tr>
                  <td><%= user.uid %></td>
                  <td>
                    <form id="edit-<%= user._id %>" style="display: none;" action="/admin/edit-user/<%= user._id %>" method="POST">
                      <input type="text" name="username" value="<%= user.username %>" class="form-control">
                      <input type="number" name="balance" value="<%= user.balance %>" class="form-control mt-1">
                      <button type="submit" class="btn btn-success mt-1">Save</button>
                      <button type="button" class="btn mt-1" onclick="toggleEdit('<%= user._id %>')">Cancel</button>
                    </form>
                    <span id="display-<%= user._id %>"><%= user.username %></span>
                  </td>
                  <td>₹<%= user.balance %></td>
                  <td><%= user.banned ? 'Banned' : 'Active' %></td>
                  <td>
                    <button class="btn btn-primary" onclick="toggleEdit('<%= user._id %>')">Edit</button>
                    <form action="/admin/toggle-ban/<%= user._id %>" method="POST" style="display: inline">
                      <button type="submit" class="btn <%= user.banned ? 'btn-success' : 'btn-danger' %>">
                        <%= user.banned ? 'Unban' : 'Ban' %>
                      </button>
                    </form>
                  </td>
                </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Withdrawal Requests Section -->
      <div id="withdrawalSection" class="tab-pane fade">
        <div class="card mb-4">
          <div class="card-header">
            <h4>Withdrawal Requests</h4>
            <input type="text" id="withdrawalSearch" class="form-control" placeholder="Search by Order Number" onkeyup="searchWithdrawals()">
          </div>
          <div class="card-body table-responsive">
            <table class="table table-striped" id="withdrawalTable">
              <thead>
                <tr>
                  <th>Order No</th>
                  <th>User</th>
                  <th>Amount</th>
                  <th>Bank Details</th>
                  <th>Status</th>
                  <th>Time</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% withdrawals.forEach(withdrawal => { %>
                <tr>
                  <td><%= withdrawal.orderNumber %></td>
                  <td><%= withdrawal.userId.username %> (UID: <%= withdrawal.userId.uid %>)</td>
                  <td>₹<%= withdrawal.amount %></td>
                  <td>
                    Acc: <%= withdrawal.bankDetails.accountNumber %><br>
                    IFSC: <%= withdrawal.bankDetails.ifscCode %><br>
                    Name: <%= withdrawal.bankDetails.holderName %>
                  </td>
                  <td><span class="badge bg-<%= withdrawal.status === 'pending' ? 'warning' : (withdrawal.status === 'approved' ? 'success' : 'danger') %>">
                    <%= withdrawal.status %>
                  </span></td>
                  <td><%= withdrawal.date.toLocaleString('en-IN', { 
                    year: 'numeric', 
                    month: 'numeric', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true,
                    timeZone: 'Asia/Kolkata' 
                  }) %></td>
                  <td>
                    <% if (withdrawal.status === 'pending') { %>
                      <form action="/admin/withdrawal/<%= withdrawal._id %>/approve" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-success btn-sm">Approve</button>
                      </form>
                      <form action="/admin/withdrawal/<%= withdrawal._id %>/reject" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-danger btn-sm">Reject</button>
                      </form>
                    <% } %>
                  </td>
                </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Deposit Requests Section -->
      <div id="depositSection" class="tab-pane fade">
        <div class="card mb-4">
          <div class="card-header">
            <h4>Deposit Requests</h4>
            <input type="text" id="depositSearch" class="form-control" placeholder="Search by Transaction ID" onkeyup="searchDeposits()">
          </div>
          <div class="card-body table-responsive">
            <table class="table table-striped" id="depositTable">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>User</th>
                  <th>Amount</th>
                  <th>Note</th>
                  <th>UTR</th>
                  <th>Status</th>
                  <th>Time</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% deposits.forEach(function(deposit) { %>
                  <tr>
                    <td><%= deposit.orderNumber %></td>
                    <td><%= deposit.userId ? deposit.userId.username : 'N/A' %> (UID: <%= deposit.userId ? deposit.userId.uid : 'N/A' %>)</td>
                    <td>₹<%= deposit.amount %></td>
                    <td><%= typeof deposit.note === 'object' ? JSON.stringify(deposit.note) : deposit.note %></td>
                    <td><%= deposit.utr %></td>
                    <td><%= deposit.status %></td>
                    <td><%= deposit.date.toLocaleString('en-IN', { 
                      year: 'numeric', 
                      month: 'numeric', 
                      day: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit',
                      hour12: true 
                    }) %></td>
                    <td>
                      <% if (deposit.status === 'pending') { %>
                        <form style="display: inline" action="/admin/deposit/<%= deposit._id %>/success" method="POST">
                          <button class="btn btn-success btn-sm">Success</button>
                        </form>
                        <form style="display: inline" action="/admin/deposit/<%= deposit._id %>/failed" method="POST">
                          <button class="btn btn-danger btn-sm">Failed</button>
                        </form>
                      <% } %>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function searchUsers() {
      const input = document.getElementById('userSearch').value.toLowerCase();
      const table = document.getElementById('userTable');
      const rows = table.getElementsByTagName('tr');

      for (let i = 1; i < rows.length; i++) {
        const uidCell = rows[i].cells[0];
        const usernameCell = rows[i].cells[1];
        const uidText = uidCell.textContent.toLowerCase();
        const usernameText = usernameCell.textContent.toLowerCase();

        if (uidText.includes(input) || usernameText.includes(input)) {
          rows[i].style.display = '';
        } else {
          rows[i].style.display = 'none';
        }
      }
    }

    function searchWithdrawals() {
      const input = document.getElementById('withdrawalSearch').value.toLowerCase();
      const table = document.getElementById('withdrawalTable');
      const rows = table.getElementsByTagName('tr');

      for (let i = 1; i < rows.length; i++) {
        const orderCell = rows[i].cells[0];
        if (orderCell) {
          const orderText = orderCell.textContent.toLowerCase();
          rows[i].style.display = orderText.includes(input) ? '' : 'none';
        }
      }
    }

    function searchDeposits() {
      const input = document.getElementById('depositSearch').value.toLowerCase();
      const table = document.getElementById('depositTable');
      const rows = table.getElementsByTagName('tr');

      for (let i = 1; i < rows.length; i++) {
        const idCell = rows[i].cells[0];
        if (idCell) {
          const idText = idCell.textContent.toLowerCase();
          rows[i].style.display = idText.includes(input) ? '' : 'none';
        }
      }
    }

    function toggleEdit(userId) {
      const editForm = document.getElementById(`edit-${userId}`);
      const displayDiv = document.getElementById(`display-${userId}`);
      if (editForm.style.display === 'none') {
        editForm.style.display = 'block';
        displayDiv.style.display = 'none';
      } else {
        editForm.style.display = 'none';
        displayDiv.style.display = 'block';
      }
    }
  </script>
</body>
</html>